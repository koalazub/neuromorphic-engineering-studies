# HDL Development Environment

This repository provides a Nix-based development environment for SystemVerilog and VHDL projects.

## Installation

1. Clone this repository
2. Make sure you have [Nix](https://nixos.org/download.html) installed with flakes enabled
3. Run the development environment:
   ```bash
   nix develop
   ```

The flake automatically installs UTM (Universal Type Manager) for virtualisation, which is required to run Prime on macOS. Note that UTM is a large package, so the initial download may take some time.

## Development Tools Included

The flake provides:
- **iverilog**: Icarus Verilog for SystemVerilog simulation
- **verilator**: For SystemVerilog linting and synthesis
- **nvc**: VHDL compiler and simulator
- **vhdl-ls**: Language server for VHDL syntax highlighting and checking
- **python3**: For cocotb (testbench framework)
- **UTM**: For virtualisation to run Quartus Prime
- **git**: For version control
- **uv**: Python package manager
- **surfer**: For waveform visualisation (on Apple Silicon Macs)
- **verible**: For SystemVerilog formatting and linting (not available on Apple Silicon Macs)

## SystemVerilog Workflow

### Simulation with Icarus Verilog

```bash
# Compile - note the -g2012 flag for SystemVerilog support
iverilog -g2012 -o simulation_output design.sv testbench.sv

# Run simulation
vvp simulation_output

# If your testbench uses $dumpfile/$dumpvars:
surfer simulation.vcd
```

### Linting with Verilator
```bash
verilator --lint-only design.sv
```

## VHDL Workflow

### Simulation with NVC

NVC follows a three-step process similar to software development:

```bash
# 1. Analyse your VHDL source files
nvc -a design.vhd testbench.vhd

# 2. Elaborate the top-level design unit
nvc -e testbench

# 3. Run the simulation with waveform generation
nvc -r testbench --format=vcd --wave=simulation.vcd
```

These steps can be combined into a single command:
```bash
nvc -a design.vhd testbench.vhd -e testbench -r --format=vcd --wave=simulation.vcd
```

### Filtering Waveform Signals

To reduce clutter in your waveforms, you can include or exclude specific signals:
```bash
nvc -r testbench --format=vcd --wave=simulation.vcd --include="entity.signal_name" --exclude="*unused*"
```

### Viewing Waveforms

Use Surfer to view VCD files generated by either Icarus Verilog or NVC:
```bash
surfer simulation.vcd
```

## Running Quartus Prime on macOS

Since Quartus Prime doesn't run natively on macOS (especially on Apple Silicon Macs), you'll need to use virtualisation:

1. Download a Windows ISO from Microsoft's website
2. Run UTM from the terminal:
   ```bash
   utm
   ```
3. Create a new virtual machine with the Windows ISO
4. Once Windows is installed, download and install Quartus Prime Lite from Intel's website
5. Use the VM to develop and compile your projects

## VHDL/SystemVerilog Code Example

### Basic VHDL Entity and Test

```vhdl
-- half_adder.vhd
library ieee;
use ieee.std_logic_1164.all;

entity half_adder is
  port (
    a, b : in std_logic;
    sum, carry : out std_logic
  );
end entity;

architecture rtl of half_adder is
begin
  sum  a, b => b, sum => sum, carry => carry);
    
  stimulus: process
  begin
    a <= '0'; b <= '0'; wait for 10 ns;
    a <= '0'; b <= '1'; wait for 10 ns;
    a <= '1'; b <= '0'; wait for 10 ns;
    a <= '1'; b <= '1'; wait for 10 ns;
    wait;
  end process;
end architecture;
```

To simulate this VHDL example:
```bash
nvc -a half_adder.vhd half_adder_tb.vhd -e half_adder_tb -r --format=vcd --wave=half_adder.vcd
surfer half_adder.vcd
```

## Notes for Apple Silicon (M Series) Mac Users

- Verible is not available natively on ARM architecture
- Consider using Rosetta 2 to run Nix in x86_64 mode for full functionality
- Quartus Prime must be run through a Windows or Linux virtual machine using UTM
- Surfer is provided as an alternative waveform viewer for Apple Silicon Macs

## Troubleshooting

### Common Issues

- **"Unsupported system: aarch64-darwin" error**: Some packages don't support Apple Silicon natively. Try adding `allowUnsupportedSystem = true;` to your Nix configuration or use a Rosetta 2 terminal.

- **For VHDL simulation failures**: Ensure VHDL files follow IEEE standards and check for type mismatches due to VHDL's strong typing system.

- **For SystemVerilog compilation errors**: Verify you're using the `-g2012` flag with iverilog to enable SystemVerilog features.


